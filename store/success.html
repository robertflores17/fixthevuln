<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download Your Planner | FixTheVuln Store</title>
  <link rel="icon" href="/favicon.ico" sizes="any">
  <meta name="robots" content="noindex">
  <meta name="referrer" content="no-referrer">
  <link rel="dns-prefetch" href="https://static.cloudflareinsights.com">
  <link rel="preconnect" href="https://static.cloudflareinsights.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="store.css?v=10">
  <style>
    .success-page {
      max-width: 600px;
      margin: 0 auto;
      padding: 80px 24px;
      text-align: center;
      min-height: 80vh;
    }
    .success-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .success-page h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .success-sub {
      color: var(--text-secondary);
      font-size: 16px;
      margin-bottom: 40px;
    }
    .download-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 40px;
      text-align: left;
    }
    .download-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .download-info h3 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .download-info p {
      font-size: 13px;
      color: var(--text-muted);
    }
    .btn-download {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      font-family: var(--font-sans);
      white-space: nowrap;
    }
    .btn-download:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .expiry-notice {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }
    .loading-state {
      padding: 60px 0;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error-state {
      color: var(--danger);
    }
    .btn-download-all {
      display: inline-block;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px 28px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: var(--font-sans);
      margin-bottom: 24px;
    }
    .btn-download-all:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.35);
    }
    .btn-download-all:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .download-group-header {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      padding: 12px 0 4px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }
    .back-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .variant-badge {
      display: inline-block;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 50px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    /* ‚îÄ‚îÄ‚îÄ Subscription confirmation panel ‚îÄ‚îÄ‚îÄ */
    .subscription-confirm {
      background: var(--bg-card);
      border: 1px solid #10b981;
      border-radius: var(--radius-lg);
      padding: 32px 28px;
      text-align: left;
      margin-bottom: 32px;
    }
    .subscription-confirm .sub-header {
      text-align: center;
      margin-bottom: 28px;
    }
    .subscription-confirm .sub-icon {
      font-size: 56px;
      margin-bottom: 12px;
    }
    .subscription-confirm .sub-header h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #10b981, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 4px;
    }
    .subscription-confirm .sub-header p {
      color: var(--text-secondary);
      font-size: 15px;
    }
    .subscription-includes h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }
    .subscription-includes ul {
      list-style: none;
      padding: 0;
      margin: 0 0 28px;
    }
    .subscription-includes li {
      padding: 8px 0;
      font-size: 14px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .subscription-includes li:last-child {
      border-bottom: none;
    }
    .subscription-includes li .check {
      color: #10b981;
      font-weight: 700;
      flex-shrink: 0;
    }
    .subscription-date {
      background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(6,182,212,0.08));
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      margin-bottom: 24px;
    }
    .subscription-date h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    .subscription-date p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 6px;
    }
    .subscription-date .pt-date {
      display: inline-block;
      background: linear-gradient(135deg, #10b981, #06b6d4);
      color: white;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
    }
    .subscription-actions {
      text-align: center;
      margin-top: 8px;
    }
    .subscription-actions .btn-kit {
      display: inline-block;
      background: linear-gradient(135deg, #10b981, #06b6d4);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px 28px;
      font-size: 15px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s;
      font-family: var(--font-sans);
    }
    .subscription-actions .btn-kit:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }
    .subscription-actions .help-link {
      display: block;
      margin-top: 14px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .subscription-actions .help-link a {
      color: #10b981;
      text-decoration: none;
    }
    .subscription-actions .help-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="nav-bar">
    <a href="/" class="nav-back">‚Üê Back to FixTheVuln</a>
    <div class="nav-controls">
      <button class="btn-icon" id="themeToggle" aria-label="Toggle theme">‚òÄÔ∏è</button>
    </div>
  </nav>

  <div class="success-page" id="successPage">
    <!-- Loading state (shown while verifying) -->
    <div id="loadingState" class="loading-state">
      <div class="spinner"></div>
      <p>Verifying your payment...</p>
    </div>

    <!-- Success state (shown after verification) -->
    <div id="successState" style="display:none">
      <div class="success-icon">‚úÖ</div>
      <h1>Payment Successful!</h1>
      <p class="success-sub">Thank you for your purchase. Your downloads are ready.</p>

      <div id="downloadAllWrap" style="display:none">
        <button class="btn-download-all" id="btnDownloadAll" onclick="downloadAll()">Download All Files</button>
      </div>

      <div class="download-list" id="downloadList">
        <!-- Download cards injected by JS -->
      </div>

      <div class="expiry-notice">
        üïê Download links expire in <strong>24 hours</strong>. Save your files after downloading.<br>
        Need help? Contact us at <strong>hello@fixthevuln.com</strong>.
      </div>

      <a href="store.html" class="back-link">‚Üê Browse more planners</a>
    </div>

    <!-- Subscription state (shown for sprint kit subscriptions) -->
    <div id="subscriptionState" style="display:none">
      <div class="subscription-confirm">
        <div class="sub-header">
          <div class="sub-icon">‚úÖ</div>
          <h1>You're Subscribed!</h1>
          <p>Patch Tuesday Sprint Kit ‚Äî $4.99/mo</p>
        </div>

        <div class="subscription-includes">
          <h3>Your monthly intelligence PDF includes:</h3>
          <ul>
            <li><span class="check">‚úì</span> Pre-filled Triage Matrix with real CISA KEV data</li>
            <li><span class="check">‚úì</span> Patch Priority Score for every CVE</li>
            <li><span class="check">‚úì</span> 14-Day Sprint Calendar with actual dates &amp; CVE IDs</li>
            <li><span class="check">‚úì</span> Testing &amp; Rollback Checklist with that month's vendors</li>
            <li><span class="check">‚úì</span> Executive Summary with auto-generated narrative &amp; charts</li>
          </ul>
        </div>

        <div class="subscription-date">
          <h3>When to expect it</h3>
          <p>Your PDF arrives via email within 24 hours of Patch Tuesday.</p>
          <p>Next Patch Tuesday: <span class="pt-date" id="nextPTDate"></span></p>
          <p style="margin-top:8px;font-size:13px;color:var(--text-muted);">Check your inbox ‚Äî we just sent you a welcome email.</p>
        </div>

        <div class="subscription-actions">
          <a href="patch-tuesday-kit.html#triage-matrix" class="btn-kit">Start with the free browser templates ‚Üí</a>
          <p class="help-link">Need help? <a href="mailto:hello@fixthevuln.com">hello@fixthevuln.com</a></p>
        </div>
      </div>

      <a href="store.html" class="back-link">‚Üê Back to store</a>
    </div>

    <!-- Error state -->
    <div id="errorState" style="display:none">
      <div class="success-icon">‚ùå</div>
      <h1 class="error-state">Verification Failed</h1>
      <p class="success-sub">We couldn't verify your payment. If you were charged, please contact <strong>hello@fixthevuln.com</strong>.</p>
      <a href="store.html" class="back-link">‚Üê Back to store</a>
    </div>
  </div>

  <!-- Footer -->
  <footer class="store-footer">
    <div class="footer-links">
      <a href="/">Home</a>
      <a href="/planner">Free Study Planner</a>
      <a href="store.html">Store</a>
      <a href="/privacy.html">Privacy</a>
      <a href="/terms.html">Terms</a>
    </div>
    <p class="footer-copy">&copy; 2026 FixTheVuln. Educational resources for security professionals.</p>
  </footer>

  <script>
    const VERIFY_URL = 'https://fixthevuln-checkout.robertflores17.workers.dev/verify';

    const VARIANT_LABELS = {
      standard: 'Standard',
      adhd: 'ADHD-Friendly',
      dark: 'Dark Mode',
      bundle: 'Complete Bundle',
    };

    const CAREER_PATH_NAMES = {
      'comptia-trifecta': 'CompTIA Trifecta',
      'comptia-a-plus': 'CompTIA A+ Complete',
      'comptia-security-track': 'CompTIA Security Track',
      'security-pro': 'Security Pro',
      'aws-track': 'AWS Track',
      'azure-track': 'Azure Track',
      'cloud-fundamentals': 'Cloud Fundamentals',
      'isaca-grc': 'ISACA GRC',
      'isc2-path': 'ISC2 Path',
      'cisco-path': 'Cisco Path',
    };

    const CERT_NAMES = {
      'comptia-a-plus-1201': 'CompTIA A+ Core 1',
      'comptia-a-plus-1202': 'CompTIA A+ Core 2',
      'comptia-security-plus': 'CompTIA Security+',
      'comptia-network-plus': 'CompTIA Network+',
      'comptia-linux-plus': 'CompTIA Linux+',
      'comptia-cloud-plus': 'CompTIA Cloud+',
      'comptia-cysa-plus': 'CompTIA CySA+',
      'comptia-pentest-plus': 'CompTIA PenTest+',
      'comptia-casp-plus': 'CompTIA CASP+',
      'isc2-cc': 'ISC2 CC',
      'isc2-sscp': 'ISC2 SSCP',
      'isc2-cissp': 'ISC2 CISSP',
      'isc2-ccsp': 'ISC2 CCSP',
      'aws-cloud-practitioner': 'AWS Cloud Practitioner',
      'aws-solutions-architect': 'AWS Solutions Architect',
      'aws-developer': 'AWS Developer Associate',
      'aws-cloudops': 'AWS CloudOps Engineer',
      'aws-security-specialty': 'AWS Security Specialty',
      'ms-az-900': 'Azure Fundamentals',
      'ms-az-104': 'Azure Administrator',
      'ms-az-305': 'Azure Solutions Architect',
      'ms-sc-900': 'Security Fundamentals',
      'ms-ai-900': 'Azure AI Fundamentals',
      'cisco-ccna': 'Cisco CCNA',
      'cisco-ccnp-encor': 'Cisco CCNP ENCOR',
      'cisco-cyberops': 'Cisco CyberOps',
      'isaca-cisa': 'ISACA CISA',
      'isaca-cism': 'ISACA CISM',
      'isaca-crisc': 'ISACA CRISC',
      'giac-gsec': 'GIAC GSEC',
      'google-ace': 'Google Cloud Engineer',
      'google-pca': 'Google Cloud Architect',
    };

    // Theme toggle
    const saved = localStorage.getItem('ftv_theme');
    if (saved === 'light') {
      document.documentElement.setAttribute('data-theme', 'light');
      document.getElementById('themeToggle').textContent = 'üåô';
    }
    document.getElementById('themeToggle').addEventListener('click', () => {
      const isLight = document.documentElement.getAttribute('data-theme') === 'light';
      if (isLight) {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
        localStorage.setItem('ftv_theme', 'dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
        document.getElementById('themeToggle').textContent = 'üåô';
        localStorage.setItem('ftv_theme', 'light');
      }
    });

    // Patch Tuesday calculator (2nd Tuesday of the month)
    function getNextPatchTuesday() {
      const now = new Date();
      let year = now.getFullYear();
      let month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const dayOfWeek = firstDay.getDay();
      const firstTue = ((9 - dayOfWeek) % 7) + 1;
      const secondTue = firstTue + 7;
      const pt = new Date(year, month, secondTue);
      if (now >= pt) {
        month++;
        if (month > 11) { month = 0; year++; }
        const fd = new Date(year, month, 1);
        const dow = fd.getDay();
        const ft = ((9 - dow) % 7) + 1;
        return new Date(year, month, ft + 7);
      }
      return pt;
    }

    function formatPatchTuesday(date) {
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
    }

    // HTML sanitization
    function esc(str) {
      const d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    // Verify payment and show downloads
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session_id');

      if (!sessionId) {
        showError();
        return;
      }

      try {
        const response = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId }),
        });

        const data = await response.json();

        if (!data.verified) {
          showError();
          return;
        }

        // Clear the cart
        localStorage.removeItem('ftv_cart');

        // Subscription flow ‚Äî show confirmation panel instead of downloads
        if (data.mode === 'subscription') {
          const ptDate = getNextPatchTuesday();
          document.getElementById('nextPTDate').textContent = formatPatchTuesday(ptDate);
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('subscriptionState').style.display = 'block';
          return;
        }

        // Show downloads, grouped by career path
        const downloadList = document.getElementById('downloadList');

        // Separate career path downloads from individual downloads
        const grouped = {};
        const individual = [];
        for (const dl of data.downloads) {
          if (dl.careerPathId) {
            if (!grouped[dl.careerPathId]) grouped[dl.careerPathId] = [];
            grouped[dl.careerPathId].push(dl);
          } else {
            individual.push(dl);
          }
        }

        let html = '';

        // Render career path groups
        for (const [pathId, downloads] of Object.entries(grouped)) {
          const pathName = CAREER_PATH_NAMES[pathId] || pathId;
          html += `<div class="download-group-header">${esc(pathName)} Career Path</div>`;
          html += downloads.map(dl => renderDownloadCard(dl)).join('');
        }

        // Render individual downloads
        if (individual.length > 0) {
          if (Object.keys(grouped).length > 0) {
            html += `<div class="download-group-header">Individual Planners</div>`;
          }
          html += individual.map(dl => renderDownloadCard(dl)).join('');
        }

        downloadList.innerHTML = html;

        // Show "Download All" button if 2+ files (only allow URLs from our worker)
        allDownloadUrls = data.downloads
          .map(dl => dl.url)
          .filter(url => url && url.startsWith('https://fixthevuln-checkout.'));
        if (allDownloadUrls.length >= 2) {
          document.getElementById('downloadAllWrap').style.display = 'block';
        }

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('successState').style.display = 'block';

      } catch (err) {
        console.error('Verification error:', err);
        showError();
      }
    }

    let allDownloadUrls = [];

    function downloadAll() {
      const btn = document.getElementById('btnDownloadAll');
      btn.disabled = true;
      btn.textContent = 'Starting downloads...';
      allDownloadUrls.forEach((url, i) => {
        setTimeout(() => {
          const a = document.createElement('a');
          a.href = url;
          a.download = '';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          if (i === allDownloadUrls.length - 1) {
            btn.textContent = 'All downloads started!';
          }
        }, i * 600);
      });
    }
    // Expose to onclick
    window.downloadAll = downloadAll;

    function renderDownloadCard(dl) {
      const certName = CERT_NAMES[dl.certId] || dl.certId;
      const variantLabel = VARIANT_LABELS[dl.variant] || dl.variant;
      const isZip = dl.filename && dl.filename.endsWith('.zip');
      const btnLabel = isZip ? 'Download ZIP' : 'Download PDF';
      // Validate URL starts with expected domain to prevent javascript: injection
      const safeUrl = dl.url && dl.url.startsWith('https://fixthevuln-checkout.') ? dl.url : '#';
      return `
        <div class="download-card">
          <div class="download-info">
            <h3>${esc(certName)} <span class="variant-badge">${esc(variantLabel)}</span></h3>
            <p>${esc(dl.filename)}</p>
          </div>
          <a class="btn-download" href="${esc(safeUrl)}" download>${btnLabel}</a>
        </div>
      `;
    }

    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
    }

    init();
  </script>
  <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "8304415b01684a00adedcbf6975458d7"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>
