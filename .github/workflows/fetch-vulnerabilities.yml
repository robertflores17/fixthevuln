name: Fetch CISA KEV Vulnerabilities

on:
  schedule:
    # Runs daily at 6 AM UTC (adjust to your timezone)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allows manual trigger for testing

jobs:
  fetch-and-create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run KEV fetch script
        id: fetch
        run: |
          python scripts/fetch_kev.py

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create or update PR branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Configure git
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          # Create/switch to draft branch
          BRANCH_NAME="auto/kev-update-$(date +'%Y-%m-%d')"

          # Check if branch exists remotely
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            git fetch origin $BRANCH_NAME
            git checkout $BRANCH_NAME
            git merge main --no-edit || true
          else
            git checkout -b $BRANCH_NAME
          fi

          # Commit changes
          git add -A
          git commit -m "Auto-fetch: CISA KEV update $(date +'%Y-%m-%d')" || echo "No changes to commit"

          # Push branch
          git push -u origin $BRANCH_NAME --force

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create or update Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")

          # Read summary for PR body
          SUMMARY=""
          if [ -f "data/REVIEW_SUMMARY.md" ]; then
            SUMMARY=$(cat data/REVIEW_SUMMARY.md)
          fi

          PR_BODY="## Automated CISA KEV Fetch

          This PR contains new vulnerability data from the CISA Known Exploited Vulnerabilities catalog.

          **Action Required:** Review the pending vulnerabilities before merging.

          ---

          $SUMMARY

          ---

          ### How to Review

          1. Check \`data/pending_review.json\` for new entries
          2. For each vulnerability you want to publish:
             - Set \`include_on_site: true\`
             - Add your \`custom_remediation\` text
             - Set \`priority\` (high/medium/low)
          3. Move reviewed entries to \`data/reviewed_kev.json\`
          4. Merge this PR when ready

          *Auto-generated by GitHub Actions*"

          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR"
            gh pr edit $EXISTING_PR --body "$PR_BODY"
          else
            echo "Creating new PR"
            gh pr create \
              --title "Weekly Vulnerability Update - Review Needed ($(date +'%Y-%m-%d'))" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME"
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "### New vulnerabilities fetched" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f "data/REVIEW_SUMMARY.md" ]; then
              cat data/REVIEW_SUMMARY.md >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### No new vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "The CISA KEV catalog has no new entries since last fetch." >> $GITHUB_STEP_SUMMARY
          fi
